---
title: "Baseline analysis"
format: 
  html:
    code-fold: true
  pdf: default
execute:
  keep-md: true
---

```{r, echo=FALSE, message=FALSE}
library(patchwork)
library(tidyverse)
library(targets)
library(arrow)

theme_set(theme_bw())

options(dplyr.summarise.inform = FALSE)

setup_schema <- schema(
  `[run number]` = int64(), `initial-norm` = int64(), b_norm = int64(), 
  `sharing-incentive` = float64(), `application-penalty` = int64(), 
  `resources-dist` = utf8(), `sharing-costs?` = bool(), `proposal-sigma` = float64(), 
  `n-teams` = int64(), `originator-benefit` = float64(), `third-party-funding-ratio` = int64(), 
  `utility-change` = float64(), b_utility = int64(), network = utf8(), 
  `funded-share` = int64(), `redistribute-costs?` = bool(), 
  `data-sharing?` = bool(), `initial-utility` = int64(), `[step]` = int64(), 
  `gini [resources] of teams` = float64(), `gini [total-funding] of teams` = float64(), 
  `mean [effort] of teams` = float64(), `%-sharing` = int64(), 
  `mean-funding-within teams with [initial-resources-quantile = "q1"]` = float64(), 
  `mean-funding-within teams with [initial-resources-quantile = "q2"]` = float64(), 
  `mean-funding-within teams with [initial-resources-quantile = "q3"]` = float64(), 
  `mean-funding-within teams with [initial-resources-quantile = "q4"]` = float64())


df_all <- open_dataset(tar_read(baseline_file),
                   format = "csv", schema = setup_schema, skip = 1,
                   convert_options = CsvConvertOptions$create(
                     null_values = "<RuntimePrimitiveException>")
                   )

df <- select_baseline(df_all)

# work with lower proposal sigma for now
df <- df %>% 
  filter(proposal_sigma == .15)
```


# Effect of grant size
```{r}
#| label: fig-vary-share-of-funded-teams
#| fig-cap: Gini index and % of groups sharing data dependnt on grant size
#| fig-height: 9
#| fig-width: 9
no_network <- df %>% 
  filter(network == "none")
  
no_network_unif_dist <- no_network %>% 
  filter(init_dist == "uniform")


pdata <- no_network_unif_dist %>% 
  group_by(step, funded_share) %>% 
  summarise(mean_gini = mean(resources_gini),
            mean_cumulative_gini = mean(total_funding_gini),
            mean_sharing = mean(perc_sharing)) %>% 
  collect()

p1 <- pdata %>%  
  ggplot(aes(step, mean_gini, colour = as.factor(funded_share))) +
  geom_line() +
    labs(colour = "% of groups receiving funding",
       y = "Gini of current resources")

p2 <- pdata %>%  
  ggplot(aes(step, mean_cumulative_gini, colour = as.factor(funded_share))) +
  geom_line() +
    labs(colour = "% of groups receiving funding",
       y = "Gini of total resources")

p3 <- pdata %>%  
  ggplot(aes(step, mean_sharing, colour = as.factor(funded_share))) +
  geom_line() +
  labs(colour = "% of groups receiving funding",
       y = "% of groups sharing data") 

p1 / p2 / p3 +
  plot_layout(guides = "collect") & theme(legend.position = "top")
```

The above is very interesting: we are not changing incentives, however sharing 
rate still varies widely. This is a consequence of how exposed agents are to
the funding agency. If only few are funded, not many come into contact. However,
if almost everyone is funded, the policy seems to work only very slowly, because
there is no advantage in sharing or not (because anyways almost everyone is
funded). It is also interesting that sharing initially rises, but then drops 
again (for low values of funded share). 

The Gini is in some sense a direct effect of selectivity of funding and thus not
particularly interesting when doing this baseline aspect.


@fig-variability visualises variability in the runs.
```{r, eval=FALSE}
#| label: fig-variability
#| fig-cap: Variability in % of groups sharing data with no network

no_network %>% 
  # filter(funded_share == 50) %>% 
  ggplot(aes(step, perc_sharing, group = run_number,
             colour = as.factor(funded_share))) +
  geom_line(alpha = .2) +
  theme(legend.position = "top") +
  labs(colour = "% of groups receiving funding",
       y = "% of groups sharing data") +
  guides(colour = guide_legend(override.aes = list(alpha = 1)))
```

## Comparing network effects
```{r, fig.width=10, fig.height=10}
#| label: fig-network-effect
#| fig-cap: "Effect of networks on (A) rate of sharing and (B) Gini coefficient. 
#|           The rows represent the varying rate of funded teams in %. Uniform 
#|           starting distribution."


uniform <- df %>% 
  filter(init_dist == "uniform")

pdata <- uniform %>% 
  select(run_number, network, funded_share, step, perc_sharing, resources_gini,
         total_funding_gini) %>% 
  group_by(network, funded_share, step) %>% 
  summarise(mean_gini = mean(resources_gini),
            mean_cumulative_gini = mean(total_funding_gini),
            mean_sharing = mean(perc_sharing)) %>% 
  collect() %>% 
  pivot_longer(c(mean_gini, mean_sharing, mean_cumulative_gini))

p_gini <- pdata %>% 
  filter(name == "mean_gini") %>% 
  ggplot(aes(step, value, colour = network)) +
  geom_line() +
  facet_wrap(vars(funded_share), ncol = 1) +
  labs(y = "Mean Gini")

p_sharing <- pdata %>% 
  filter(name == "mean_sharing") %>% 
  ggplot(aes(step, value, colour = network)) +
  geom_line() +
  facet_wrap(vars(funded_share), ncol = 1) +
  labs(y = "Mean % of teams sharing data")

p_sharing + p_gini +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(legend.position = "top")

```

The red lines in @fig-variability correspond to @fig-vary-share-of-funded-teams.
We can observe that the Gini is not substantially affected by different network
structures, while the share of teams sharing data is strongly affected by the
presence of network effects, but only weakly by the type of network.

Overall, network effects lead to a lower share of teams that share data, 
presumably because we start with no teams sharing data, and therefore the 
descriptive norms act as a dampener. However, for larger grants (and a lower
share of teams that is funded each round), the share of groups sharing data
swings widely between two extreme points, before settling on a narrower 
equilibrium state.

## Effect on success of different groups
```{r}
group_success <- no_network %>% 
  group_by(step, funded_share, init_dist) %>% 
  summarise(across(contains("mean_funds"), .fns = mean)) %>% 
  collect()
```

```{r}
#| label: fig-resources-by-quantile
#| fig-cap: Mean resources by initial resource quantile with no network
#| fig-width: 10
#| fig-height: 10


pdata <- group_success %>% 
  pivot_longer(contains("mean_funds"), names_to = "quantile",
               names_pattern = ".*_(q\\d)")
  

pdata %>% 
  ggplot(aes(step, value, colour = quantile)) +
  geom_line() +
  facet_grid(rows = vars(funded_share),
             cols = vars(init_dist))
```

There is no difference in how successful groups are based on their initial
quantile, when there are not networks. Below we provide the same for a 
random network (@fig-resources-by-quantile-random-network), and for a 
small-world network (@fig-resources-by-quantile-small-world-network).


```{r, fig.width=10, fig.height=10}
#| label: fig-resources-by-quantile-random-network
#| fig-cap: Mean resources by initial resource quantile with random network

group_success <- df %>% 
  filter(network == "random") %>% 
  group_by(step, funded_share, init_dist) %>% 
  summarise(across(contains("mean_funds"), .fns = mean)) %>% 
  collect()

pdata <- group_success %>% 
  pivot_longer(contains("mean_funds"), names_to = "quantile",
               names_pattern = ".*_(q\\d)")

pdata %>% 
  ggplot(aes(step, value, colour = quantile)) +
  geom_line() +
  facet_grid(rows = vars(funded_share),
             cols = vars(init_dist))
```

```{r, fig.width=10, fig.height=10}
#| label: fig-resources-by-quantile-small-world-network
#| fig-cap: Mean resources by initial resource quantile with small-world network

group_success <- df %>% 
  filter(network == "small-world") %>% 
  group_by(step, funded_share, init_dist) %>% 
  summarise(across(contains("mean_funds"), .fns = mean)) %>% 
  collect()

pdata <- group_success %>% 
  pivot_longer(contains("mean_funds"), names_to = "quantile",
               names_pattern = ".*_(q\\d)")

pdata %>% 
  ggplot(aes(step, value, colour = quantile)) +
  geom_line() +
  facet_grid(rows = vars(funded_share),
             cols = vars(init_dist))
```


In both cases there are slight differences, but I assume these are just random
variation. Maybe the methodology of grouping teams based on their initial 
resources into four quartiles is not very useful - these are large groups that
hide more fine-grained processes.